"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ConfigService=void 0;var utils_1=require("../utils/utils"),error_1=require("../error/error"),error_message_1=require("../error/error-message"),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),common_log_1=require("../log-config/common-log"),ConfigService=function(){function f(){this.configMap=new Map}return f.initialLoadServiceConfig=function(e,r){if((0,utils_1.voilidatePath)(r),!f.INSTANCES.has(e)){var t=new f;try{for(var o=fs_1.default.readFileSync(r,"utf8"),n=JSON.parse(o),i=0,a=Object.keys(n);i<a.length;i++){var s=a[i];t.configMap.set(s,n[s])}f.INSTANCES.set(e,t)}catch(e){throw new error_1.AGCError(error_message_1.ErrorCodeConstant.LOAD_SERVICE_CONFIG_ERROR)}}},f.loadCustomConfig=function(){try{var e=process.cwd(),r=fs_1.default.readdirSync(e);f.priorInstance.configMap.clear();for(var t=0;t<r.length;t++){var o=path_1.default.join(e,r[t]);if(fs_1.default.statSync(o).isFile()&&r[t].match(f.CONFIG_REGEX))for(var n=fs_1.default.readFileSync(o,"utf8"),i=JSON.parse(n),a=0,s=Object.keys(i);a<s.length;a++){var c=s[a];f.priorInstance.configMap.set(c,i[c])}}}catch(e){common_log_1.logger.error("load custom config failed",e)}},f.getService=function(e){return f.INSTANCES.has(e)?f.INSTANCES.get(e):f.priorInstance},f.startPollingTask=function(){setInterval(function(){f.loadCustomConfig()},f.POLLING_INTERVAL_IN_MILLISECONDS)},f.prototype.getConfigValue=function(e,r){return f.priorInstance.configMap.has(e)?f.priorInstance.configMap.get(e):this.configMap.has(e)?this.configMap.get(e):r},f.CONFIG_REGEX="agconnect-[\\w]+.json",f.POLLING_INTERVAL_IN_MILLISECONDS=3e5,f.priorInstance=new f,f.INSTANCES=new Map,f}();exports.ConfigService=ConfigService;
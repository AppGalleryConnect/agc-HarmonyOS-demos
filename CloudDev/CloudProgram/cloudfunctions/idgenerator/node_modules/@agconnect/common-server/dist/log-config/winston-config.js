"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.logConfig=void 0;var error_1=require("../error/error"),error_message_1=require("../error/error-message"),winston=require("winston"),path_1=__importDefault(require("path")),winston_daily_rotate_file_1=__importDefault(require("winston-daily-rotate-file")),defaultLogDir="../logs",defaultLogLevel="info",defaultMaxSize="20m",defaultMaxFiles="14d",defaultPrefix="common",defaultMetaInfo="common-server",defaultLogSwitch="off";function logConfig(e){var t,o=getConfigInfo(readConfigFile(e)),r=path_1.default.join(path_1.default.dirname(e),o.defaultLogDir),a=path_1.default.join(r,"exceptions.log"),e=path_1.default.join(r,"error.log"),r=path_1.default.join(r,o.defaultPrefix+"-%DATE%.log");return creatInstance(o,t="on"===o.defaultLogSwitch?logTransportsConfig(o,e,r):t,a)}function readConfigFile(e){var t;try{t=require(e)}catch(e){throw new error_1.AGCError(error_message_1.ErrorCodeConstant.FS_READ_FAIL)}return t}function getConfigInfo(e){var t=e.switch;t&&(defaultLogSwitch=t);var o=e.file_name_prefix;o&&(defaultPrefix=o);t=e.path;t&&(defaultLogDir=t);o=e.file_level;o&&(defaultLogLevel=o);t=e.maxSize;t&&(defaultMaxSize=t);o=e.maxFiles;o&&(defaultMaxFiles=o);t=defaultLogLevel,o=e.console_level,e=e.service;return{defaultLogSwitch:defaultLogSwitch,defaultPrefix:defaultPrefix,defaultLogDir:defaultLogDir,defaultLogLevel:defaultLogLevel,defaultMaxSize:defaultMaxSize,defaultMaxFiles:defaultMaxFiles,defaultConsoleLevel:t=o?o:t,defaultMetaInfo:defaultMetaInfo=e?e:defaultMetaInfo}}exports.logConfig=logConfig;var formatter=winston.format.combine(winston.format.splat(),winston.format.timestamp({format:"YYYY-MM-DD HH:mm:ss SSS"}),winston.format.printf(function(e){if(!e.private)return"["+e.service+"] "+e.timestamp+" "+e.level+":"+e.message}));function logTransportsConfig(e,t,o){return{console_config:new winston.transports.Console({level:e.defaultConsoleLevel}),file:new winston.transports.File({level:"error",filename:t}),rotateFile:new winston_daily_rotate_file_1.default({filename:o,datePattern:"YYYY-MM-DD-HH",zippedArchive:!0,maxFiles:e.defaultMaxFiles,maxSize:defaultMaxSize,frequency:"3h"})}}function creatInstance(e,t,o){e="on"===e.defaultLogSwitch?winston.createLogger({level:e.defaultLogLevel,format:formatter,defaultMeta:{service:e.defaultMetaInfo},transports:[t.console_config,t.file,t.rotateFile],exceptionHandlers:[new winston.transports.File({filename:o}),new winston.transports.Console],exitOnError:!1}):winston.createLogger({level:e.defaultLogLevel,format:formatter,defaultMeta:{service:e.defaultMetaInfo},transports:[new winston.transports.Console({level:"error"})],exceptionHandlers:[new winston.transports.Console],exitOnError:!1});return e}